<!DOCTYPE html>
<html>
	<head>
		<title>Rootify</title>
        
        <!-- jQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        
        <!-- jQuery UI -->
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        
        <!-- D3.js v3 -->
		<script src="http://d3js.org/d3.v3.min.js"></script>
		
		<!-- Spotify Web API (JS client-side wrapper) -->
		<script src="/js/spotify-web-api.js"></script>
        
        <!-- Main CSS -->
        <link rel="stylesheet" type="text/css" href="/css/home.css">
        
        <!-- jQuery CSS -->
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	</head>
    
	<body>
        <!-- Header  -->
        <div id="tophead">
            <div class="navbar">

                <a id="logout-b">Logout</a>
                
                <a style="margin-left: 25px;" id="short-term">Short-Term</a>
                <a id="long-term">Long-Term</a>
                
                <a style="margin-left: 25px;" id="reset_tree">Reset Tree</a>
                
                <label style="color: white;"><input type='checkbox' id="popCheck" onclick='handleClick(this);'>Popularity</label>
                <br>
                <label style="color: white;"><input type='checkbox' id="energyCheck" onclick='handleClick(this);'>Energy</label>
                <br>
                <label style="color: white;"><input type='checkbox' id="danceCheck" onclick='handleClick(this);'>Danceability</label>
                <br>
                <label style="color: white;"><input type='checkbox' id="posCheck" onclick='handleClick(this);'>Positivity</label>
                
                <div>
                    <div id="pop_slider_text" class="range-slider-text">Popularity: 0 - 100</div>
                    <div id="pop_slider" class="range-slider"></div>
                    
                    <div id="dance_slider_text" class="range-slider-text">Danceability: 0 - 100</div>
                    <div id="dance_slider" class="range-slider"></div>
                    
                    <div id="energy_slider_text" class="range-slider-text">Energy: 0 - 100</div>
                    <div id="energy_slider" class="range-slider"></div>
                    
                    <div id="valence_slider_text" class="range-slider-text">Positivity: 0 - 100</div>
                    <div id="valence_slider" class="range-slider"></div>
                </div>
                
                <script type="application/javascript">
                    var filterOptions = {
                        pop_slider: { typ: "popularity", values: [0, 100] }, 
                        dance_slider: { typ: "dance", values: [0, 100] }, 
                        energy_slider: { typ: "energy", values: [0, 100] }, 
                        valence_slider: { typ: "valence", values: [0, 100] }
                    };
                    
                    function filterNode(d, element) {
                        if (d.root || d.spacer) { return; }
                        var pass = true;

                        for (var key in filterOptions) {
                            var typ = filterOptions[key].typ;
                            var range = filterOptions[key].values;
                            
                            var featValue = d[typ] * 100;
                            var min = range[0];
                            var max = range[1];
                            
                            if (featValue < min || featValue > max) {
                                pass = false;
                                break;
                            }
                        }

                        d3.select(element).select("image").style("opacity", pass ? 1 : 0.05);
                    }
                    
                    function filterNodes() {
                        var node = svgGroup.selectAll("g.node");
    
                        // For each node in the set..
                        node.each(function(d) {
                            filterNode(d, this);
                        });
                    }
                    
                    function upperCaseFirstLetter(string) {    
                        if (string == "valence") {
                            return "Positivity";
                        } else if (string == "dance") {
                            return "Danceability";
                        }
                        return string.charAt(0).toUpperCase() + string.slice(1);
                    }
                    
                    $( function() {
                        for (var key in filterOptions) {
                            $( "#" + key ).slider({
                                range: true,
                                min: 0,
                                max: 100,
                                values: [0, 100],
                                change: function (event, ui) {
                                    var min = ui.values[0];
                                    var max = ui.values[1];
                                    
                                    var id = $(this).attr("id");
                                    filterOptions[id].values = [min, max];
                                    
                                    filterNodes();
                                }, 
                                slide: function(event, ui) {
                                    var min = ui.values[0];
                                    var max = ui.values[1];
                                    var id = $(this).attr("id");

                                    var typ = filterOptions[id].typ;
                                    
                                    $("#" + id + "_text").html(upperCaseFirstLetter(typ) + ": " + min + " - " + max); 
                                }
                            });
                        }
                    });
                    
                    var scaleOptions = {
                        popCheck: false, 
                        energyCheck: false, 
                        danceCheck: false, 
                        posCheck: false
                    };
                    
                    function handleClick(cb) {
                        scaleOptions[cb.id] = cb.checked;
                        resizeNodes();
                    }
                </script>
            </div>
        </div>
        

        <!-- Sidebar -->
        <div id="sidebar">

            <!-- Tabs -->
             <div id="tabs" class="c-tabs no-js">
                <div class="tabnav">
                    <a href="#" class="tablink is-active">
                        Details
                    </a>
                    <a href="#" class="tablink">
                        Generate
                    </a>
                </div>
                
                <!-- Tabs Content  -->
                <div class="c-tab is-active">
                    <div id="overflowss" class="tabcontent">
                        <h2> Details </h2>
                        <div class="tabcontentinner" id="detailsTab">
                            
                            <div id="headerImage" width="100%"></div>
                            <div id="spotifyTracks" width="100%"></div>

                            <div id="at-container">
                                <svg id="detailsSVG"></svg>
                            </div>
                            
                            <div id="detailsGenres" width="100%"><p style="padding-left: 8px; padding-right: 8px;"></p></div>
                        </div>
                    </div>
                </div>

                <div class="c-tab">
                    <div id="overflowss" class="tabcontent">
                        <h2> Selected </h2>
                        <div class="tabcontentinner" id="selectedTracks">
                            
                        </div>
                        
                        
                        <div class="tabcontentinner" id= "selectedArtists">
                            
                        </div>
                        
                        
                        <h2> Recommended Playlist </h2>
                             <div class="tabcontentinnerdif">
                                <p> 1. Track
                                <p> 2. Track
                                <p> 3. Track
                                <p> 4. Track
                                <p> 5. Track
                                <p> 6. Track
                                <p> 7. Track
                                <p> 8. Track
                                <p> 9. Track
                                <p> 10. Track
                                <p> 11. Track
                                <p> 12. Track
                                <p> 13. Track
                                <p> 14. Track
                                <p> 15. Track
                                <p> 16. Track
                                <p> 17. Track
                                <p> 18. Track
                                <p> 19. Track
                                <p> 20. Track
                                <p> 21. Track
                            </div>

                        <!-- Button  -->
                        <a class="playlistbtn" href="#">Generate Playlist</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tree Container -->
        <div id="tree-container">
            
        <script type="text/javascript">
            function getCookie(name) {
                var re = new RegExp(name + "=([^;]+)");
                var value = re.exec(document.cookie);
                return (value != null) ? unescape(value[1]) : null;
            }
            
            function deleteCookie(name) {
                document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            }
            
            var spotifyApi = new SpotifyWebApi();
            var access_token = "<%- access_token -%>";
            //var access_token = "<%- access_token -%>";
            
            var access_token = getCookie("myToken");
            var refresh_token = getCookie("myRefreshToken");
            
            spotifyApi.setAccessToken(access_token);

            if (access_token == null || access_token == "") {
                window.location.replace('http://localhost:8888/');
            } else {
                spotifyApi.setAccessToken(access_token);
            }
        </script>

        </div>  
        <!-- End Tree Container !Do not Delete! div make sure the script is in the tree container -->

        <!-- bottom pop out bar -->
        <div id="bottom-bar">
            <button type="button" class="btn btn-default">Toggle</button>

            <div id="slideout">
                <div id="leftside"></div>
                <div id="rightside"></div>
            </div>
        </div>

        <!-- bottom pop up bar script -->
        <script>
            $('button').click(function(){
                $('#slideout').toggleClass('on');
            });
        </script>
        
        <!-- Details tab -->
        <script type="text/javascript" src="/js/detailsTab.js"></script>
        
        <!-- Resize code -->
        <script type="text/javascript">
            
            // Tree container
            var treeDiv = document.getElementById("tree-container");
            // Artist track container
            var atDiv = document.getElementById("at-container");
            
            
            var selectedType = null;
            
            var svg = d3.select(treeDiv).append("svg").attr("id", "baseSVG");
            
            var viewerWidth;
            var viewerHeight;
            
            var viewerW2, viewerH2;
            
            // For the bars in the 'Details' tab
            var barManager = new BarManager();
            
            function redraw() {
                // Extract the width and height that was computed by CSS.
                viewerWidth = treeDiv.clientWidth;
                viewerHeight = treeDiv.clientHeight;
                
                // Use the extracted size to set the size of an SVG element.
                svg
                .attr("width", viewerWidth)
                .attr("height", viewerHeight)
                .attr("class", "overlay");
                
                // Resize the the details SVG
                viewerW2 = atDiv.clientWidth;
                viewerH2 = atDiv.clientHeight;
                
                d3.select("#detailsSVG")
                    .attr("width", viewerW2)
                    .attr("height", viewerH2);
                
                barManager.updateBars();
            }

            // Draw for the first time to initialize.
            redraw();

            // Redraw based on the new size whenever the browser window is resized.
            window.addEventListener("resize", redraw);
        </script>
        
        <!-- Tree layout -->
        <script type="text/javascript" src="/js/layouts.js"></script>
        
        <!-- TAB JS -->
        <script src="/js/tabs.js"></script>
        <script>
            var myTabs = tabs({
                el: '#tabs',
                tabNavigationLinks: '.tablink',
                tabContentContainers: '.c-tab'
            });
            myTabs.init();
        </script>
	</body>
</html>